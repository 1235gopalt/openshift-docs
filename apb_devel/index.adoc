[[apb-devel-intro]]
= Introduction
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

[[apb-devel-intro-about]]
== About This Guide

This guide outlines the design concepts and workflow of
link:https://github.com/ansibleplaybookbundle/ansible-playbook-bundle[Ansible Playbook Bundles (APBs)], shows how to install and use the `apb` CLI tooling,
and provides a tutorial and reference material on writing your own APBs.

[[apb-devel-intro-design]]
== Design Overview

An APB is a lightweight application definition that borrows several concepts
from the link:https://github.com/projectatomic/nulecule[Nulecule] and
link:http://www.projectatomic.io/docs/atomicapp/[Atomicapp] projects, namely the
concept of a short-lived container with the sole purpose of orchestrating the
deployment of the intended application. For the case of APBs, this short-lived
container is the APB itself: a container with an
link:https://www.ansible.com/[Ansible] runtime environment plus any files
required to assist in orchestration, such as playbooks, roles, and extra
dependencies.

The
xref:../architecture/service_catalog/ansible_service_broker.adoc#arch-ansible-service-broker[OpenShift Ansible broker] (OAB) is an implementation of the Open Service Broker (OSB) API
that manages applications defined by APBs. The OAB is supported and deployed by
default starting in {product-title} 3.7.

Specification of an APB is intended to be lightweight, consisting of several
named playbooks and a metadata file to capture information such as parameters to
pass into the application.

[[apb-devel-intro-workflow]]
== Workflow

The APB workflow is broken up into the following steps:

. Preparation
.. APB initialization
.. APB spec file
.. Actions (provision, deprovision, bind, unbind)
. Build
. Deploy

[[apb-devel-intro-prep]]
=== Preparation

You must prepare your APB's directory structure and spec file before you can
build and deploy it. The
xref:writing/getting_started.adoc#apb-devel-writing-getting-started[Getting Started] topic provides a step by step tutorial on creating your first APB,
while the following sections briefly cover this workflow.

[[apb-devel-intro-apb-init]]
==== APB Initialization

////
image::apb-prepare.png[]
////

The `apb init` command creates the required skeleton directory structure and a
few required files (for example, the *_apb.yml_* spec file) for the APB.

The following shows an example directory structure of an APB:

[[apb-directory-structure]]
.Directory Structure
----
example-apb/
├── Dockerfile
├── apb.yml
└── roles/
│   └── example-apb-openshift
│       ├── defaults
│       │   └── main.yml
│       └── tasks
│           └── main.yml
└── playbooks/
    └── provision.yml
    └── deprovision.yml
    └── bind.yml
    └── unbind.yml
----

[[apb-devel-intro-spec-file]]
==== APB Spec File

An APB spec file (*_apb.yml_*) must be edited for your specific application. For
example, the default spec file after running `apb init` looks as follows:

[source,yaml]
----
version: 1.0
name: my-test-apb
description: This is a sample application generated by apb init
bindable: False
async: optional
metadata: <1>
  displayName: my-test
plans:
  - name: default
    description: This default plan deploys my-test-apb
    free: True
    metadata: {}
    parameters: [] <2>
----
<1> The `metadata` field is optional and used when integrating with the
{product-title} service catalog.
<2> For APBs that do not have any parameters, the `parameters` field should be
blank.

[NOTE]
====
See the xref:writing/reference.adoc#apb-devel-writing-ref-spec[Reference] topic
for a fully-defined example APB spec file.
====

[[apb-devel-intro-actions]]
==== Actions

The following are the actions for an APB. At a minimum, an APB must implement
the provision and deprovision actions:

*_provision.yml_*::
Playbook called to handle installing application to the cluster.

*_deprovision.yml_*::
Playbook called to handle uninstalling.

*_bind.yml_*::
Playbook to grant access to another service to use this service, such as
generating credentials.

*_unbind.yml_*::
Playbook to revoke access to this service.

*_test.yml_*::
(Optional) Playbook to test that the APB is vaild.

The required named playbooks correspond to methods defined by the OSB API. For
example, when the OAB needs to provision an APB it will execute
*_provision.yml_*.

After the required named playbooks have been generated, the files can be used
directly to test management of the application. A developer may want to work
with this directory of files, make tweaks, run, repeat until they are happy with
the behavior. They can test the playbooks by invoking Ansible directly with the
playbook and any required variables.

[[apb-devel-intro-build]]
=== Build

The build step is responsible for building a container image from the named
playbooks for distribution. Packaging combines a base image containing an
Ansible runtime with Ansible artifacts and any dependencies required to run the
playbooks.

The result is a container image with an `ENTRYPOINT` set to take in several
arguments, one of which is the method to execute, such as provision and
deprovision.

.APB Build
image::OpenShift_ContainterPlatform_APB-DevelopmentGuide_463015_1117_ECE_Build.png[]
////
image::apb-package.png[]
////

[[apb-devel-intro-deploy]]
=== Deploy

Deploying an APB means invoking the container and passing in the name of the
playbook to execute along with any required variables. It is possible to invoke
the APB directly without going through the OAB. Each APB is packaged so its
`ENTRYPOINT` will invoke Ansible when run. The container is intended to be
short-lived, coming up to execute the Ansible playbook for managing the
application then exiting.

In a typical APB deploy, the APB container will provision an application by
running the *_provision.yml_* playbook, which executes a deployment role. The
deployment role is responsible for creating the {product-title} resources,
perhaps through calling `oc create` commands or leveraging Ansible modules. The
end result is that the APB runs Ansible to talk to {product-title} to
orchestrate the provisioning of the intended application.

////
image::OpenShift_ContainterPlatform_APB-DevelopmentGuide_463015_1117_ECE_Deploy.png[]
<1> The OAB deploys the APB using:
+
----
$ oc run $IMAGE $METHOD $VARS ansible-playbook ${METHOD}.yaml ${VARS}
----
+
In the short-lived container:
+
--
. `oc run` launches Ansible,
. Ansible executes `${METHOD}.yaml`, and
. exits at the end of the run.
--
====
////

.APB Deploy
image::apb-deploy.png[]
