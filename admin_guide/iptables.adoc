[[admin-guide-iptables]]
= iptables
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview
The kernel iptables component is used for a variety of traffic
filtering, routing, and monitoring purposes:

. Most hosts will use either <<firewalld>> or
<<iptables-service,iptables.service>> to manage firewall rules.

. {product-title} adds rules to ensure that generic firewall rules
don't accidentally end up restricting traffic between pods.

. {product-title} adds rules to properly route and load-balance
traffic to service IP addresses, and to accept traffic for services
using
xref:../dev_guide/getting_traffic_into_cluster.adoc#using-nodeport[NodePorts].

. Docker and some other software on the system may also use iptables
rules for their own purposes.

. Finally, administrators may want to add their own local rules to log
or filter traffic.

Components that access the kernel iptables rules directly work without knowledge
of how other components are using them. This makes it very easy for one component
to break another component's configuration. For that reason, we recommend that if
administrators want to create their own rules, they should use
firewalld.

[[firewalld]]
== firewalld

link:http://firewalld.org/[Firewalld] is a daemon that manages iptables rules and
provides a standard API for adding and editing rules in a way that avoids
conflicts between different applications. Firewalld is the preferred
iptables-management system for {product-title}, and the
xref:../install_config/install/advanced_install.adoc#install-config-install-advanced-install[advanced installation method]
will configure a firewalld-based firewall by default on new installations.

When using firewalld, use the
link:http://www.firewalld.org/documentation/man-pages/firewall-cmd[`firewall-cmd`]
tool to manage iptables rules. Use the `--permanent` flag to edit the permanent
configuration that will be preserved after restarts.

[WARNING]
====
If you use `firewall-cmd --direct` to directly add "raw" iptables rules, you must
be careful to avoid interfering with the rules that {product-title} and Docker
add. The easiest way to do this is to restrict yourself to the `_direct` tables
provided by firewalld. (eg, use the `FORWARD_direct` table rather than
`FORWARD`).
====

[[iptables-service]]
== iptables.service

On older systems, or systems that do not support firewalld, you may have a
firewall managed by *iptables.service*. As with firewalld, *iptables.service*
assumes total control of the iptables configuration, but unlike firewalld it does
not provide any way for applications such as {product-title} to dynamically manage
their own iptables rules. When *iptables.service* starts, it flushes and restores
the complete iptables configuration. The restored rules are from its configuration
file, *_/etc/sysconfig/iptables_*. The configuration file is not kept up to date
during operation, so the dynamically added rules are lost during every restart.

[WARNING]
====
Stopping and starting *iptables.service* will destroy configuration that is
required by {product-title} and Docker. {product-title} and Docker are not
notified of the change.
====

If you need to run *iptables.service*, keep a limited configuration in the
configuration file and rely on {product-title} and Docker to install their
needed rules.

The *iptables.service* configuration is loaded from:

----
/etc/sysconfig/iptables
----

To make permanent rules changes, edit the changes into this file. Do not include
Docker or {product-title} rules.

After *iptables.service* is started or restarted on a node, the Docker service
and *atomic-openshift-node.service* must be restarted to reconstruct the needed
iptables configuration.

[IMPORTANT]
====
Restarting the Docker service will cause all containers running on the node to
be stopped and restarted.
====

----
# systemctl restart iptables.service
# systemctl restart docker
# systemctl restart atomic-openshift-node.service
----
